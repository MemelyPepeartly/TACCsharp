name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: true
      DOTNET_NOLOGO: true
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
      NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify export preset
        run: |
          test -f export_presets.cfg || { echo "Missing export_presets.cfg in repo."; exit 1; }
          grep -E "name=|platform=|export_path=" export_presets.cfg || true
          if grep -q 'export_path=""' export_presets.cfg; then
            echo "export_path is empty in export_presets.cfg."
            exit 1
          fi

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "6.0.x"

      - name: Install export dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-6 libxcursor1 libxrandr2 libxi6 libxinerama1 libgl1 libglu1-mesa xvfb zip

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: "4.3.0"
          use-dotnet: true
          include-templates: true

      - name: Resolve Godot binary
        run: |
          if [ -n "${GODOT4:-}" ]; then
            echo "GODOT_BIN=$GODOT4" >> "$GITHUB_ENV"
          elif [ -n "${GODOT:-}" ]; then
            echo "GODOT_BIN=$GODOT" >> "$GITHUB_ENV"
          else
            echo "GODOT_BIN=godot" >> "$GITHUB_ENV"
          fi

      - name: Verify Godot (.NET)
        run: |
          version="$($GODOT_BIN --version)"
          echo "$version"
          echo "$version" | grep -qi mono || { echo "Godot .NET build not detected: $version"; exit 1; }

      - name: Verify export templates
        run: |
          templates_root="$HOME/.local/share/godot/export_templates"
          test -d "$templates_root" || { echo "Missing export templates directory: $templates_root"; exit 1; }
          find "$templates_root" -maxdepth 2 -type d -print
          template_exe="$(find "$templates_root" -name 'windows_release_x86_64*.exe' | head -n 1)"
          test -n "$template_exe" || { echo "Missing Windows export template (windows_release_x86_64*.exe)."; exit 1; }
          echo "$template_exe"

      - name: Generate C# bindings
        run: |
          xvfb-run -a "$GODOT_BIN" --headless --path . --build-solutions --quit

      - name: Restore dependencies
        run: dotnet restore

      - name: Build C# assemblies
        run: dotnet build ./TACCsharp.csproj --configuration Release

      - name: Export Windows release
        run: |
          mkdir -p build
          log_path="build/godot-export.log"

          set +e
          xvfb-run -a "$GODOT_BIN" --headless --verbose --path . --export-release "Windows Desktop" "build/TACCsharp.exe" 2>&1 | tee "$log_path"
          export_exit=${PIPESTATUS[0]}
          set -e

          if [ $export_exit -ne 0 ]; then
            echo "Godot export-release failed with exit code $export_exit"
            exit $export_exit
          fi

          if [ -f build/TACCsharp.exe ]; then
            ls -la build
            exit 0
          fi

          echo "Export-release did not emit an .exe. Falling back to export-pack + template exe."
          set +e
          xvfb-run -a "$GODOT_BIN" --headless --verbose --path . --export-pack "Windows Desktop" "build/TACCsharp.pck" 2>&1 | tee -a "$log_path"
          pack_exit=${PIPESTATUS[0]}
          set -e

          if [ $pack_exit -ne 0 ]; then
            echo "Godot export-pack failed with exit code $pack_exit"
            exit $pack_exit
          fi
          test -f build/TACCsharp.pck || { echo "Missing build/TACCsharp.pck after export-pack."; exit 1; }

          template_exe="$(find "$HOME/.local/share/godot/export_templates" -name 'windows_release_x86_64*.exe' | head -n 1)"
          test -n "$template_exe" || { echo "Missing Windows export template (windows_release_x86_64*.exe)."; exit 1; }
          cp "$template_exe" "build/TACCsharp.exe"
          test -f build/TACCsharp.exe || { echo "Missing build/TACCsharp.exe after copying template."; exit 1; }
          ls -la build

      - name: Package artifact
        run: |
          mkdir -p dist
          (cd build && zip -r ../dist/TACCsharp-Windows.zip .)
          ls -la dist
          test -f dist/TACCsharp-Windows.zip || { echo "Missing dist/TACCsharp-Windows.zip after packaging."; exit 1; }

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: TACCsharp-Windows
          path: dist/TACCsharp-Windows.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/TACCsharp-Windows.zip
          fail_on_unmatched_files: true
