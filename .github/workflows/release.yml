name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: true
      DOTNET_NOLOGO: true
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
      NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "6.0.x"

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: "4.3.0"
          use-dotnet: true
          include-templates: true

      - name: Resolve Godot binary
        run: |
          $godot = $env:GODOT4
          if (-not $godot) { $godot = $env:GODOT }
          if (-not $godot) { $godot = "godot" }
          "GODOT_BIN=$godot" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Verify Godot (.NET)
        run: |
          $version = & $env:GODOT_BIN --version
          $version
          if ($version -notmatch "mono") { throw "Godot .NET build not detected: $version" }

      - name: Generate C# bindings
        run: |
          & $env:GODOT_BIN --headless --path . --build-solutions --quit

      - name: Restore dependencies
        run: dotnet restore

      - name: Build C# assemblies
        run: dotnet build .\TACCsharp.csproj --configuration Release

      - name: Export Windows release
        run: |
          New-Item -ItemType Directory -Path build -Force | Out-Null
          $global:LASTEXITCODE = 0
          & $env:GODOT_BIN --headless --verbose --path . --export-release "Windows Desktop" "build/TACCsharp.exe"
          $godotOk = $?
          $exitCode = $LASTEXITCODE
          if ($exitCode -eq $null) { $exitCode = 0 }
          Write-Host "Godot exit code: $exitCode"
          if (-not $godotOk -or $exitCode -ne 0) { throw "Godot export failed with exit code $exitCode" }
          Get-ChildItem -Path build -Recurse
          $exeFiles = Get-ChildItem -Path build -Filter *.exe -Recurse
          if (-not $exeFiles) { throw "Missing .exe output in build/ after export." }

      - name: Package artifact
        run: |
          New-Item -ItemType Directory -Path dist -Force | Out-Null
          Compress-Archive -Path build/* -DestinationPath dist/TACCsharp-Windows.zip -Force
          Get-ChildItem -Path dist
          if (!(Test-Path "dist/TACCsharp-Windows.zip")) { throw "Missing dist/TACCsharp-Windows.zip after packaging." }

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: TACCsharp-Windows
          path: dist/TACCsharp-Windows.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/TACCsharp-Windows.zip
          fail_on_unmatched_files: true
